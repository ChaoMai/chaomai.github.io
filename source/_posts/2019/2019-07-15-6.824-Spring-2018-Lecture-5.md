---
title: 6.824 2018 Lecture 5 Fault Tolerance Raft
date: 2019-07-15 15:13:32
categories:
    - "distritubed system"
tags:
    - 6.824
    - replication
    - raft
---

# Readings - In Search of an Understandable Consensus Algorithm (Extended Version) (to end of Section 5)论文
## Introduction
共识算法（Consensus algorithms）允许一组机器作为一个一致的组工作，这个组可以在某些成员失败的情况下存活。Paxos是过去10多年最常被讨论的共识算法，但是难以理解且不便于实现。提出Raft的主要目标是可理解性。通过解耦leader选举、log复制和安全，以及减少状态空间，来增加可理解性。

**复制状态机（Replicated state machine）与共识算法**
共识算法常常出现在复制状态机的讨论中。

![-w384](/images/2019/15633494887544.jpg)

复制状态机常用于解决分布式系统中的各种容错问题，使用复制log来实现，每个状态机以相同的顺序执行相同的命令，最终算出相同的状态和结果。保证replicated log的一致是由共识算法来实现的。

共识算法一般有以下几个特征：
* 安全：*非拜占庭条件*（网络问题、丢包、乱序）下，不返回任何错误的结果。
* 可用性：大多数server可用，则系统整体可用。
* 不依赖时间来保证日志的一致性。
* 大多数server执行完毕则返回，少量慢server不影响系统性能。

## Raft
raft的工作过程是，首先选举leader，leader会负责管理replicated log。leader接受来自client的log，复制到其他机器，并在安全的时候通知其他机器把log输入状态机。

raft可以解耦为以下三个部分：
1. leader选举（Leader election）
2. 日志复制（Log replication）
3. 安全（Safety）

在理解这三个部分前，有几个基本概念需要知道，
**server 状态**
* leader：只能有一个leader
* follower：只响应来自其他server的请求
* candidate：用于选举

![-w433](/images/2019/15633584684199.jpg)

**时间**
raft把时间分为terms，term由一个递增的数字标识，表示*current term*。每个term以leader选举作为起始，如果未选举出leader，那么下一个term继续选。term内选举出的leader管理集群直到term结束。

![-w351](/images/2019/15633589391342.jpg)

不同的server可能观察到不同的term转换，server使用current term（在server通信的时候发送）作为逻辑时钟，来确保能够探测到过期的信息。

**通信**
使用rpc。基本的共识算法使用两种rpc，
* RequestVote RPCs：candidates发起，用于选主
* AppendEntries RPCs：leader发起，用于复制日志和心跳。

### leader选举（Leader election）
在状态图中，状态转换的上方表示触发转换的event，下方表示发生转换时执行的action。

![leader election](/images/2019/leader%20election.jpg)

**随机election timeout**
raft使用随机election timeout来保证，
* split votes（分裂投票）会很少出现。
    C先timeout，然后投票给自己，并发送RequestVote RPCs，最终成为win。
    ![-w397](/images/2019/15634274004241.jpg)

* 且split votes能够被快速解决。如果出现split votes，candidate先等待随机election timeout。

### 日志复制（Log replication）
### 安全（Safety）

# Lecture

# Lab 2A: Raft
